<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Do / Schedule / Delegate Board (Persistent + Drafts)</title>
<style>
body { font-family: Arial, sans-serif; background:#f5f5f5; padding:20px; }
h1 { text-align:center; margin-bottom:18px; }

.board { display:flex; gap:20px; justify-content:center; flex-wrap:wrap; }
.tile { background:#fff; padding:16px; border-radius:12px; width:320px; box-shadow:0 4px 10px rgba(0,0,0,0.12); }
.tile-title { font-size:20px; font-weight:bold; margin-bottom:10px; }
.tile-do { border-top:8px solid #e53935; background:#ffebee; }
.tile-schedule { border-top:8px solid #43a047; background:#e8f5e9; }
.tile-delegate { border-top:8px solid #fdd835; background:#fffde7; }

textarea { width:100%; height:70px; padding:8px; resize:vertical; box-sizing:border-box; }
button.add-btn { width:100%; padding:8px; margin-top:8px; background:#0288d1; color:white; border:none; border-radius:6px; cursor:pointer; }
.deadline-input { margin-top:8px; display:flex; flex-direction:column; font-size:0.9rem; }
.deadline-input label { margin-bottom:4px; }
.deadline-input input[type="date"] { padding:6px; border-radius:4px; border:1px solid #bbb; width:100%; }

ul { list-style:none; padding:0; margin-top:12px; max-height:420px; overflow:auto; }
li { background:white; border:1px solid #ccc; border-radius:6px; padding:8px; margin-bottom:8px; display:flex; flex-direction:column; }
.row { display:flex; align-items:center; gap:8px; }
.task-text { word-break:break-word; flex:1 1 auto; }
.delete-btn { margin-left:8px; background:#c62828; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:12px; }
.completed { text-decoration:line-through; color:#444; }
.date-note, .deadline-note { font-size:0.82rem; font-style:italic; margin-left:26px; color:#444; }
.overdue { color:#d32f2f; font-weight:bold; margin-left:26px; font-size:0.85rem; }
.meta { display:flex; justify-content:space-between; gap:8px; align-items:center; margin-top:8px; }
.small { font-size:0.85rem; color:#666; }
.footer { text-align:center; margin-top:14px; font-size:0.9rem; color:#666; }
</style>
</head>
<body>

<h1>Do / Schedule / Delegate</h1>

<div class="board">

<!-- DO Panel -->
<div class="tile tile-do" data-panel="do">
<p class="tile-title">Do</p>
<textarea placeholder="Enter a comment/task..." data-input-text data-panel-input="do"></textarea>
<div class="deadline-input">
<label for="deadline-do">Deadline date:</label>
<input type="date" id="deadline-do" data-input-deadline data-panel-deadline="do">
</div>
<button class="add-btn" onclick="addComment('do')">Add Comment</button>
<ul id="list-do"></ul>
</div>

<!-- SCHEDULE Panel -->
<div class="tile tile-schedule" data-panel="schedule">
<p class="tile-title">Schedule</p>
<textarea placeholder="Enter a comment/task..." data-input-text data-panel-input="schedule"></textarea>
<div class="deadline-input">
<label for="deadline-schedule">Deadline date:</label>
<input type="date" id="deadline-schedule" data-input-deadline data-panel-deadline="schedule">
</div>
<button class="add-btn" onclick="addComment('schedule')">Add Comment</button>
<ul id="list-schedule"></ul>
</div>

<!-- DELEGATE Panel -->
<div class="tile tile-delegate" data-panel="delegate">
<p class="tile-title">Delegate</p>
<textarea placeholder="Enter a comment/task..." data-input-text data-panel-input="delegate"></textarea>
<div class="deadline-input">
<label for="deadline-delegate">Deadline date:</label>
<input type="date" id="deadline-delegate" data-input-deadline data-panel-deadline="delegate">
</div>
<button class="add-btn" onclick="addComment('delegate')">Add Comment</button>
<ul id="list-delegate"></ul>
</div>

</div>

<div class="footer">
Saved locally in this browser. Drafts are preserved between reloads.
</div>

<script>
/* ---------- Storage keys & default ---------- */
const STORAGE_KEY = 'dsd_tasks_v3'; // tasks + meta
const DRAFTS_KEY = 'dsd_drafts_v1'; // drafts for textareas/date inputs

const defaultState = { do: [], schedule: [], delegate: [] };
let state = loadJson(STORAGE_KEY, defaultState);
let drafts = loadJson(DRAFTS_KEY, { do: { text: '', deadline: '' }, schedule: { text: '', deadline: '' }, delegate: { text: '', deadline: '' } });

/* ---------- helpers ---------- */
function loadJson(key, fallback) {
try {
const raw = localStorage.getItem(key);
if (!raw) return JSON.parse(JSON.stringify(fallback));
return Object.assign(JSON.parse(JSON.stringify(fallback)), JSON.parse(raw));
} catch (e) {
console.error('loadJson error for', key, e);
return JSON.parse(JSON.stringify(fallback));
}
}
function saveJson(key, obj) {
try { localStorage.setItem(key, JSON.stringify(obj)); } catch (e) { console.error('saveJson error', e); }
}
function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function todayISO() { return new Date().toISOString().split('T')[0]; }
function formatDateTime(iso) {
if (!iso) return '';
const d = new Date(iso);
const dd = String(d.getDate()).padStart(2,'0'), mm = String(d.getMonth()+1).padStart(2,'0'), yyyy = d.getFullYear();
const hh = String(d.getHours()).padStart(2,'0'), min = String(d.getMinutes()).padStart(2,'0');
return `${dd}-${mm}-${yyyy} ${hh}:${min}`;
}
function escapeHtml(str) { return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'", '&#039;'); }

/* ---------- Rendering ---------- */
function clearList(panel) { document.getElementById(`list-${panel}`).innerHTML = ''; }

function renderTask(panel, task) {
const ul = document.getElementById(`list-${panel}`);
const li = document.createElement('li');
li.dataset.id = task.id;

const checked = task.completed ? 'checked' : '';
const completedClass = task.completed ? 'completed' : '';
const deadlineHtml = task.deadline ? `<div class="deadline-note">Deadline: ${task.deadline}</div>` : '';
const overdueHtml = task.deadline ? `<div class="overdue" style="display:none;">âš  OVERDUE</div>` : '';
const completedNote = task.completedAt ? `<div class="date-note">Completed on ${formatDateTime(task.completedAt)}</div>` : '<div class="date-note"></div>';

li.innerHTML = `
<div class="row">
<input type="checkbox" ${checked} data-action="toggle">
<div class="task-text ${completedClass}">${escapeHtml(task.text)}</div>
<button class="delete-btn" data-action="delete">Delete</button>
</div>
${deadlineHtml}
${overdueHtml}
${completedNote}
`;

li.querySelector('[data-action="toggle"]').addEventListener('change', (e) => toggleComplete(panel, task.id, e.target.checked));
li.querySelector('[data-action="delete"]').addEventListener('click', () => deleteTask(panel, task.id));

ul.appendChild(li);

if (task.deadline) checkOverdueForElement(li, task);
}

function renderAll() {
['do','schedule','delegate'].forEach(panel => {
clearList(panel);
state[panel].forEach(task => renderTask(panel, task));
});
}

/* ---------- Drafts handling: save & restore ---------- */
function initDraftInputs() {
['do','schedule','delegate'].forEach(panel => {
const textarea = document.querySelector(`[data-panel-input="${panel}"]`);
const dateInput = document.querySelector(`[data-panel-deadline="${panel}"]`);
// restore draft values
if (drafts[panel]) {
if (textarea) textarea.value = drafts[panel].text || '';
if (dateInput) dateInput.value = drafts[panel].deadline || '';
}
// listen for changes and persist immediately
if (textarea) {
textarea.addEventListener('input', () => {
drafts[panel].text = textarea.value;
saveJson(DRAFTS_KEY, drafts);
});
}
if (dateInput) {
dateInput.addEventListener('change', () => {
drafts[panel].deadline = dateInput.value || '';
saveJson(DRAFTS_KEY, drafts);
});
}
});
}

/* ---------- CRUD operations ---------- */
function addComment(panel) {
const tile = document.querySelector(`.tile[data-panel="${panel}"]`);
const textarea = tile.querySelector('[data-panel-input="' + panel + '"]');
const dateInput = tile.querySelector('[data-panel-deadline="' + panel + '"]');
const text = (textarea.value || '').trim();
if (!text) return;

const deadline = dateInput && dateInput.value ? dateInput.value : '';

const task = { id: uid(), text, deadline, completed: false, completedAt: null, createdAt: new Date().toISOString() };
state[panel].push(task);
saveJson(STORAGE_KEY, state);
renderTask(panel, task);

// clear inputs and drafts for this panel
textarea.value = '';
if (dateInput) dateInput.value = '';
drafts[panel] = { text: '', deadline: '' };
saveJson(DRAFTS_KEY, drafts);
}

function toggleComplete(panel, id, isComplete) {
const list = state[panel];
const idx = list.findIndex(t => t.id === id);
if (idx === -1) return;
list[idx].completed = !!isComplete;
list[idx].completedAt = isComplete ? new Date().toISOString() : null;
saveJson(STORAGE_KEY, state);

const li = document.querySelector(`#list-${panel} li[data-id="${id}"]`);
if (!li) return;
const textDiv = li.querySelector('.task-text');
const dateNote = li.querySelector('.date-note');
const overdueEl = li.querySelector('.overdue');

if (isComplete) {
textDiv.classList.add('completed');
dateNote.textContent = `Completed on ${formatDateTime(list[idx].completedAt)}`;
if (overdueEl) overdueEl.style.display = 'none';
} else {
textDiv.classList.remove('completed');
dateNote.textContent = '';
if (list[idx].deadline) checkOverdueForElement(li, list[idx]);
}
}

function deleteTask(panel, id) {
state[panel] = state[panel].filter(t => t.id !== id);
saveJson(STORAGE_KEY, state);
const li = document.querySelector(`#list-${panel} li[data-id="${id}"]`);
if (li) li.remove();
}

/* ---------- Overdue logic ---------- */
function checkOverdueForElement(li, task) {
if (!task.deadline) return;
const overdueEl = li.querySelector('.overdue');
const checkbox = li.querySelector('input[type="checkbox"]');
if (!overdueEl || checkbox.checked) { if (overdueEl) overdueEl.style.display = 'none'; return; }
const today = todayISO();
overdueEl.style.display = (today > task.deadline) ? 'block' : 'none';
}

function checkAllOverdues() {
['do','schedule','delegate'].forEach(panel => {
state[panel].forEach(task => {
const li = document.querySelector(`#list-${panel} li[data-id="${task.id}"]`);
if (li) checkOverdueForElement(li, task);
});
});
}

/* ---------- Init ---------- */
renderAll();
initDraftInputs();
checkAllOverdues();
setInterval(checkAllOverdues, 30000);

</script>

</body>
</html>